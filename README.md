<h2>Background</h2>
<div>&nbsp;</div>
<div>When our applications need to communicate with many other services or components, we will meet temporary faults due to some of services or components that cannot respond in time.</div>
<div>&nbsp;</div>
<div>There are many reasons for those temporary faults -- timeouts, overloaded resources, networking hiccups and so on. Most of them are hard to reproduce because these failures are usually self-correcting. </div>
<div>&nbsp;</div>
<div>We can't avoid failures, but we can respond in ways that will keep our system up or at least minimize downtime. </div>
<div>&nbsp;</div>
<div>For example, an application service with a throttling strategy is processing plenty of concurrent requests, and some of the requests will be rejected quickly. But if we can try again after a delay, it might succeed. Retry is an effective and easy way to handle transient failures. </div>
<div>&nbsp;</div>
<div>And in this article, we will discuss it in ASP.NET Core via Polly.</div>
<div>&nbsp;</div>
<div>
<h2>What Is Polly?</h2>
</div>
<div>
<div align="center"><img class="" data-src="https://csharpcorner-mindcrackerinc.netdna-ssl.com/article/using-retry-pattern-in-asp-net-core-via-polly/Images/polly.png" alt="Using Retry Pattern In ASP.NET Core Via Polly" src="https://csharpcorner-mindcrackerinc.netdna-ssl.com/article/using-retry-pattern-in-asp-net-core-via-polly/Images/polly.png"></div>
</div>
<div>&nbsp;</div>
<div>Polly is a .NET resilience and transient-fault-handling library that allows developers to express policies such as Retry, Circuit Breaker, Timeout, Bulkhead Isolation, and Fallback in a fluent and thread-safe manner.</div>
<h3 id="retry-n-times">Retry n Times</h3>
<p>The <code>RetryForever</code> policy already covered a part of the requirements we identified initially, but the concept of a potentially infinite number of calls to <code>PersistApplicationData</code> is not what we had in mind. So we could opt for the <code>Retry</code> policy instead. <code>Retry</code> behaves very similar to <code>RetryForever</code> with the key difference that it expects a numeric argument which specifies the actual number of retry attempts before it gives up.</p>
<div class="code-toolbar"><pre class=" language-csharp"><code class=" language-csharp">Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Retry</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>PersistApplicationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C#</span></div></div></div>
<p>Similarly, there is also an overload of <code>Retry</code> that allows the caller to handle an eventual exception and additionally receives an int argument specifying how many times the call has already been attempted.</p>
<div class="code-toolbar"><pre class=" language-csharp"><code class=" language-csharp">Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Retry</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">Log</span><span class="token punctuation">(</span>$<span class="token string">"Error '{e.Message}' at retry #{i}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>PersistApplicationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C#</span></div></div></div>
<h3 id="wait-and-retry">Wait and Retry</h3>
<p>The last requirement that is still unfulfilled from the initial example is the possibility to throttle the execution of the retry mechanism, hoping that the flaky resource which originally caused this issue might have recovered by now.</p>
<p>Again, Polly provides a specific policy for that use case called <code>WaitAndRetry</code>. The simplest overload of <code>WaitAndRetry</code> expects a collection of <code>Timespan</code> instances and the size of this collection implicitly dictates the number of retries. Consequently, the individual <code>Timespan</code> instances specify the waiting time before each <code>Execute</code> call.</p>
<div class="code-toolbar"><pre class=" language-csharp"><code class=" language-csharp">Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">WaitAndRetry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>PersistApplicationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C#</span></div></div></div>
<p>If we wanted to calculate those wait times dynamically, another overload of <code>WaitAndRetry</code> is available.</p>
<div class="code-toolbar"><pre class=" language-csharp"><code class=" language-csharp">Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">WaitAndRetry</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> count <span class="token operator">=</span><span class="token operator">&gt;</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>PersistApplicationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C#</span></div></div></div>
<p>An infinite amount of retries using a dynamic wait time is also possible by using <code>WaitAndRetryForever</code>.</p>
<div class="code-toolbar"><pre class=" language-csharp"><code class=" language-csharp">Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">WaitAndRetryForever</span><span class="token punctuation">(</span>count <span class="token operator">=</span><span class="token operator">&gt;</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>PersistApplicationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C#</span></div></div></div>
<h3 id="circuit-breaker">Circuit Breaker</h3>
<p>The last policy we want to take a look at is slightly different from those we got to know so far. <code>CircuitBreaker</code> acts like its real-world prototype, which interrupts the flow of electricity. The software counterpart of fault current or short circuits are exceptions, and this policy can be configured in a way that a certain amount of exceptions “break” the application’s flow. This has the effect that the “protected” code (<code>PersistApplicationData</code>) simply will not get called any more, as soon as a given threshold of exceptions has been reached. Additionally, an interval can be specified, after which the <code>CircuitBreaker</code> recovers and the application flow is restored again.</p>
<p>Because of that pattern, this policy is usually used by setting it up initially and storing the actual <code>Policy</code> instance in a variable. This instance keeps track of failed calls and the recovery interval and is used to perform the <code>Execute</code> call in a different place.</p>
<div class="code-toolbar"><pre class="  language-csharp"><code class="prism  language-csharp">  <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">IOException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Or</span><span class="token punctuation">&lt;</span><span class="token class-name">UnauthorizedAccessException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">CircuitBreaker</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>PersistApplicationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C#</span></div></div></div>
https://github.com/App-vNext/Polly
